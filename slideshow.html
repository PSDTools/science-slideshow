<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slideshow</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: #000;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
        }

        #slideshow {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s;
        }

        .slide.active {
            opacity: 1;
        }

        .slide img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Weather Slide */
        .weather-slide {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px;
        }

        .weather-slide .station { font-size: 36px; opacity: 0.9; margin-bottom: 20px; }
        .weather-slide .temp { font-size: 120px; font-weight: 700; margin: 20px 0; }
        .weather-slide .details { display: flex; gap: 40px; margin-top: 40px; flex-wrap: wrap; justify-content: center; }
        .weather-slide .detail { background: rgba(255,255,255,0.15); padding: 25px 35px; border-radius: 15px; }
        .weather-slide .detail .label { font-size: 14px; opacity: 0.8; text-transform: uppercase; margin-bottom: 8px; }
        .weather-slide .detail .value { font-size: 32px; font-weight: 600; }
        .weather-slide .updated { position: absolute; bottom: 30px; font-size: 16px; opacity: 0.6; }

        #debug {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: lime;
            padding: 15px;
            font-family: monospace;
            font-size: 14px;
            border-radius: 8px;
            z-index: 9999;
            display: none;
        }
    </style>
</head>
<body>
    <div id="slideshow"></div>
    <div id="debug"></div>

    <script>
        let config = { weather: {}, slideshow: { image_duration_seconds: 5, weather_duration_seconds: 10 } };
        let images = [];
        let weather = null;
        let slides = [];
        let currentIndex = 0;
        let countdown = 5;
        let debugVisible = false;

        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                config = await response.json();
            } catch (e) {}
        }

        async function loadImages() {
            const response = await fetch('/api/images');
            const data = await response.json();
            images = data.images || [];
        }

        async function loadWeather() {
            if (!config.weather.api_key || !config.weather.station_id) return;
            try {
                const url = `https://api.weather.com/v2/pws/observations/current?stationId=${config.weather.station_id}&format=json&units=e&apiKey=${config.weather.api_key}`;
                const response = await fetch(url);
                const data = await response.json();
                weather = data.observations?.[0] || null;
            } catch (e) {}
        }

        function createWeatherSlide() {
            if (!weather) return '';
            const temp = weather.imperial?.temp != null ? Math.round(weather.imperial.temp) : '--';
            const humidity = weather.humidity ?? '--';
            const wind = weather.imperial?.windSpeed != null ? Math.round(weather.imperial.windSpeed) : '--';
            const pressure = weather.imperial?.pressure ?? '--';
            const station = weather.stationID || config.weather.station_id || '';
            const time = weather.obsTimeLocal ? new Date(weather.obsTimeLocal).toLocaleTimeString() : '';

            return `
                <div class="slide weather-slide">
                    <div class="station">${station}</div>
                    <div class="temp">${temp}Â°F</div>
                    <div class="details">
                        <div class="detail"><div class="label">Humidity</div><div class="value">${humidity}%</div></div>
                        <div class="detail"><div class="label">Wind</div><div class="value">${wind} mph</div></div>
                        <div class="detail"><div class="label">Pressure</div><div class="value">${pressure}"</div></div>
                    </div>
                    <div class="updated">Updated: ${time}</div>
                </div>
            `;
        }

        function createImageSlide(url) {
            return `<div class="slide"><img src="${url}"></div>`;
        }

        function render() {
            const container = document.getElementById('slideshow');
            container.innerHTML = '';
            slides = [];

            // Add weather slide if available
            if (weather) {
                container.innerHTML += createWeatherSlide();
                slides.push({ type: 'weather', duration: config.slideshow.weather_duration_seconds });
            }

            // Add image slides
            images.forEach(img => {
                container.innerHTML += createImageSlide(img.url);
                slides.push({ type: 'image', duration: config.slideshow.image_duration_seconds });
            });

            // Set first slide active
            const firstSlide = container.querySelector('.slide');
            if (firstSlide) firstSlide.classList.add('active');

            // Set initial countdown
            if (slides.length > 0) {
                countdown = slides[0].duration;
            }
        }

        function showSlide(index) {
            const slideEls = document.querySelectorAll('.slide');
            slideEls.forEach(s => s.classList.remove('active'));
            if (slideEls[index]) slideEls[index].classList.add('active');
        }

        function nextSlide() {
            if (slides.length === 0) return;
            currentIndex = (currentIndex + 1) % slides.length;
            showSlide(currentIndex);
            countdown = slides[currentIndex].duration;
        }

        function updateDebug() {
            document.getElementById('debug').innerHTML =
                `Slide: ${currentIndex + 1}/${slides.length}<br>` +
                `Next in: ${countdown}s<br>` +
                `Type: ${slides[currentIndex]?.type || 'none'}`;
        }

        function tick() {
            if (slides.length === 0) return;
            countdown--;
            if (countdown <= 0) nextSlide();
            if (debugVisible) updateDebug();
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'd' || e.key === 'D') {
                debugVisible = !debugVisible;
                document.getElementById('debug').style.display = debugVisible ? 'block' : 'none';
                if (debugVisible) updateDebug();
            }
        });

        async function init() {
            await loadConfig();
            await loadWeather();
            await loadImages();
            render();
            if (slides.length > 0) {
                setInterval(tick, 1000);
            }
        }

        init();
    </script>
</body>
</html>
